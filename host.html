<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Host</title>
    <style>
        .dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <h1>WebRTC Host</h1>
    <p>Dots will appear where the client clicks.</p>

    <script>
        // Create a new RTCPeerConnection
        const peerConnection = new RTCPeerConnection();

        // Handle the data channel for receiving click data
        peerConnection.ondatachannel = (event) => {
            const dataChannel = event.channel;
            dataChannel.onmessage = (event) => {
                const clickData = JSON.parse(event.data);
                spawnDot(clickData.x, clickData.y);
            };
        };

        // Handle ICE candidates
        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                // Append ICE candidate to the URL for signaling
                appendToSignalingUrl("host_ice", btoa(JSON.stringify(event.candidate)));
            }
        };

        // Append signaling data to the URL (used for demonstration purposes)
        function appendToSignalingUrl(param, value) {
            const url = new URL(window.location.href);
            url.searchParams.set(param, value);
            window.history.replaceState({}, '', url);
        }

        // Spawn a dot at the given coordinates
        function spawnDot(x, y) {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.left = `${x}px`;
            dot.style.top = `${y}px`;
            document.body.appendChild(dot);
        }

        // Wait for the client's offer and respond with an answer
        async function waitForOffer() {
            const urlParams = new URLSearchParams(window.location.search);
            while (!urlParams.has("offer")) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                urlParams.set("offer", new URLSearchParams(window.location.search).get("offer"));
            }
            const offer = JSON.parse(atob(urlParams.get("offer")));
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            appendToSignalingUrl("answer", btoa(JSON.stringify(answer)));
        }

        // Start waiting for the client's offer
        waitForOffer();
    </script>
</body>
</html>
