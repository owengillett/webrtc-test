<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Client</title>
</head>
<body>
    <h1>WebRTC Client</h1>
    <p>Click anywhere on the screen to send the click to the host.</p>

    <script>
        // Create a new RTCPeerConnection
        const peerConnection = new RTCPeerConnection();

        // Create a data channel for sending click data
        const dataChannel = peerConnection.createDataChannel("clickDataChannel");

        // Handle ICE candidates
        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                // Append ICE candidate to the URL for signaling
                appendToSignalingUrl("client_ice", btoa(JSON.stringify(event.candidate)));
            }
        };

        // Append signaling data to the URL (used for demonstration purposes)
        function appendToSignalingUrl(param, value) {
            const url = new URL(window.location.href);
            url.searchParams.set(param, value);
            window.history.replaceState({}, '', url);
        }

        // Create and send the offer to the signaling URL
        async function startConnection() {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            appendToSignalingUrl("offer", btoa(JSON.stringify(offer)));
        }

        // Wait for the host's answer
        async function waitForAnswer() {
            const urlParams = new URLSearchParams(window.location.search);
            while (!urlParams.has("answer")) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                urlParams.set("answer", new URLSearchParams(window.location.search).get("answer"));
            }
            const answer = JSON.parse(atob(urlParams.get("answer")));
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        // Capture clicks and send coordinates via the data channel
        document.addEventListener('click', (event) => {
            const clickData = {
                x: event.clientX,
                y: event.clientY
            };
            dataChannel.send(JSON.stringify(clickData));
        });

        // Start the connection
        startConnection().then(waitForAnswer);
    </script>
</body>
</html>
